---
- name: Create /opt/docker/komodo directory
  file:
    path: /opt/docker/komodo
    state: directory
    mode: '0755'

- name: Create compose.yaml for Komodo Manager
  copy:
    dest: /opt/docker/komodo/compose.yaml
    content: |
      services:
        mongo:
          container_name: komodo-mongo
          image: mongo
          labels:
            komodo.skip: # Prevent Komodo from stopping with StopAllContainers
          command: --quiet --wiredTigerCacheSizeGB 0.25
          restart: unless-stopped
          # ports:
          #   - 27017:27017
          volumes:
            - mongo-data:/data/db
            - mongo-config:/data/configdb
          env_file: .env
          environment:
            MONGO_INITDB_ROOT_USERNAME: ${KOMODO_DB_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${KOMODO_DB_PASSWORD}

        core:
          container_name: komodo-core
          image: ghcr.io/moghtech/komodo-core:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
          labels:
            komodo.skip: # Prevent Komodo from stopping with StopAllContainers
          restart: unless-stopped
          depends_on:
            - mongo
          ports:
            - 9120:9120
          env_file: .env
          environment:
            KOMODO_DATABASE_ADDRESS: mongo:27017
            KOMODO_DATABASE_USERNAME: ${KOMODO_DB_USERNAME}
            KOMODO_DATABASE_PASSWORD: ${KOMODO_DB_PASSWORD}
          volumes:
            - ${COMPOSE_KOMODO_BACKUPS_PATH}:/backups
        periphery:
          container_name: komodo-periphery
          image: ghcr.io/moghtech/komodo-periphery:${COMPOSE_KOMODO_IMAGE_TAG:-latest}
          labels:
            komodo.skip: # Prevent Komodo from stopping with StopAllContainers
          restart: unless-stopped
          env_file: .env
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /proc:/proc
            - ${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}:${PERIPHERY_ROOT_DIRECTORY:-/etc/komodo}

      volumes:
        # Mongo
        mongo-data:
        mongo-config:
    mode: '0644'

- name: Create .env for Komodo Manager
  copy:
    dest: /opt/docker/komodo/.env
    content: |
      # Image version
      COMPOSE_KOMODO_IMAGE_TAG=latest
      
      # Backup path
      COMPOSE_KOMODO_BACKUPS_PATH={{ komodo_backups_path | default('/opt/docker/komodo/backups') }}
      
      # Database credentials
      KOMODO_DB_USERNAME={{ komodo_db_username }}
      KOMODO_DB_PASSWORD={{ komodo_db_password }}
      
      # Authentication
      KOMODO_PASSKEY={{ komodo_passkey }}
      KOMODO_WEBHOOK_SECRET={{ komodo_webhook_secret }}
      KOMODO_JWT_SECRET={{ komodo_jwt_secret }}
      KOMODO_JWT_TTL=1-day
      
      # Core configuration
      KOMODO_HOST=https://demo.komo.do
      KOMODO_TITLE={{ komodo_title | default('Komodo') }}
      KOMODO_FIRST_SERVER=https://periphery:8120
      KOMODO_FIRST_SERVER_NAME=Local
      KOMODO_MONITORING_INTERVAL=15-sec
      KOMODO_RESOURCE_POLL_INTERVAL=1-hr
      
      # Local auth
      KOMODO_LOCAL_AUTH=true
      KOMODO_INIT_ADMIN_USERNAME={{ komodo_admin_username | default('admin') }}
      KOMODO_INIT_ADMIN_PASSWORD={{ komodo_admin_password }}
      KOMODO_DISABLE_USER_REGISTRATION=false
      KOMODO_ENABLE_NEW_USERS=false
      
      # Periphery configuration
      PERIPHERY_ROOT_DIRECTORY=/etc/komodo
      PERIPHERY_PASSKEYS=${KOMODO_PASSKEY}
      PERIPHERY_SSL_ENABLED=true
      PERIPHERY_INCLUDE_DISK_MOUNTS=/etc/hostname
      
      # Timezone
      TZ={{ komodo_timezone | default('Europe/Oslo') }}
    mode: '0644'

- name: Create backups directory
  file:
    path: "{{ komodo_backups_path | default('/opt/docker/komodo/backups') }}"
    state: directory
    mode: '0755'

- name: Allow Komodo Core port through firewall
  ufw:
    rule: allow
    port: '9120'
    proto: tcp

- name: Allow Komodo Periphery port through firewall
  ufw:
    rule: allow
    port: '8120'
    proto: tcp

- name: Start Komodo Manager with docker compose
  community.docker.docker_compose_v2:
    project_src: /opt/docker/komodo
    state: present
